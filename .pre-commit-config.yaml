# Pre-commit hooks for OpenAI Responses Gateway
# Install: pre-commit install
# Run manually: pre-commit run --all-files

repos:
  # Go code formatting and linting
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v4.5.0
    hooks:
      - id: trailing-whitespace
      - id: end-of-file-fixer
      - id: check-yaml
        args: [--unsafe]  # Allow custom YAML tags
      - id: check-added-large-files
        args: [--maxkb=1000]
      - id: check-merge-conflict
      - id: check-case-conflict
      - id: mixed-line-ending

  # Go formatting
  - repo: https://github.com/dnephin/pre-commit-golang
    rev: v0.5.1
    hooks:
      - id: go-fmt
      - id: go-vet
      - id: go-imports
      - id: go-mod-tidy
      - id: golangci-lint
        args: [--timeout=5m]

  # OpenAPI validation
  - repo: https://github.com/python-jsonschema/check-jsonschema
    rev: 0.27.3
    hooks:
      - id: check-jsonschema
        name: Validate OpenAPI spec
        files: ^openapi\.yaml$
        args:
          - --schemafile
          - https://raw.githubusercontent.com/OAI/OpenAPI-Specification/main/schemas/v3.0/schema.json
          - openapi.yaml

  # Open Responses conformance tests
  - repo: local
    hooks:
      # Build binaries before running tests
      - id: build-server
        name: Build server binary
        entry: make build-server
        language: system
        pass_filenames: false
        files: \.(go|mod|sum)$

      # Start server and run conformance tests
      - id: openresponses-conformance
        name: Open Responses conformance tests
        entry: scripts/run-conformance-tests.sh
        language: system
        pass_filenames: false
        files: ^(pkg/|cmd/|openapi\.yaml)

      # Validate OpenAPI spec consistency
      - id: validate-openapi-sync
        name: Check OpenAPI files are in sync
        entry: scripts/validate-openapi-sync.sh
        language: system
        pass_filenames: false
        files: ^(openapi\.yaml|pkg/adapters/http/openapi\.go)$
