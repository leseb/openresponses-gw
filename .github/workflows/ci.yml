name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read

jobs:
  pre-commit:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.24"
          cache-dependency-path: go.sum

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Run pre-commit
        uses: pre-commit/action@v3.0.1

  build-and-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.24"
          cache-dependency-path: go.sum

      - name: Download modules
        run: go mod download

      - name: Build
        run: go build ./...

      - name: Vet
        run: go vet ./...

      - name: Check formatting
        run: |
          unformatted=$(gofmt -l .)
          if [ -n "$unformatted" ]; then
            echo "The following files need formatting:"
            echo "$unformatted"
            exit 1
          fi

      - name: Test
        run: go test -race ./...

  integration-tests:
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    needs: build-and-test
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Launch vLLM container
        run: |
          docker run -d \
            --name vllm \
            --privileged=true \
            --net=host \
            quay.io/higginsd/vllm-cpu:65393ee064-qwen3 \
            --host 0.0.0.0 \
            --port 8000 \
            --enable-auto-tool-choice \
            --tool-call-parser hermes \
            --model /root/.cache/Qwen3-0.6B \
            --served-model-name Qwen/Qwen3-0.6B \
            --max-model-len 8192

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.24"
          cache-dependency-path: go.sum

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Build gateway
        run: make build

      - name: Wait for vLLM
        run: |
          echo "Waiting for vLLM to be ready..."
          timeout 900 bash -c 'until curl -fsS http://localhost:8000/health >/dev/null; do
            echo "Waiting for vLLM..."
            sleep 5
          done'
          echo "vLLM is ready"

      - name: Start gateway (HTTP + ExtProc)
        env:
          OPENAI_API_ENDPOINT: http://localhost:8000/v1
          OPENAI_API_KEY: unused
        run: |
          ./bin/openresponses-gw -config tests/envoy/config.yaml > /tmp/gateway.log 2>&1 &
          echo $! > /tmp/gateway.pid

      - name: Wait for gateway
        run: |
          echo "Waiting for gateway to be ready..."
          timeout 30 bash -c 'until nc -z localhost 10000; do
            echo "Waiting for gateway..."
            sleep 1
          done'
          echo "Gateway is ready"

      - name: Start Envoy
        run: |
          docker run -d \
            --name envoy-test \
            --net=host \
            -v ${{ github.workspace }}/tests/envoy/envoy.yaml:/etc/envoy/envoy.yaml:ro \
            envoyproxy/envoy:v1.28-latest \
            -c /etc/envoy/envoy.yaml

      - name: Wait for Envoy
        run: |
          echo "Waiting for Envoy to be ready..."
          timeout 30 bash -c 'until curl -fsS http://localhost:9901/ready >/dev/null; do
            echo "Waiting for Envoy..."
            sleep 1
          done'
          echo "Envoy is ready"

      - name: Run integration tests
        env:
          OPENRESPONSES_BASE_URL: http://localhost:8081/v1
          OPENRESPONSES_ADAPTER: envoy
          OPENRESPONSES_MODEL: Qwen/Qwen3-0.6B
        run: make test-integration

      - name: Upload gateway log
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: gateway-log
          path: /tmp/gateway.log

      - name: Collect Envoy log
        if: failure()
        run: docker logs envoy-test > /tmp/envoy.log 2>&1 || true

      - name: Upload Envoy log
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: envoy-log
          path: /tmp/envoy.log

      - name: Collect vLLM log
        if: failure()
        run: docker logs vllm > /tmp/vllm.log 2>&1 || true

      - name: Upload vLLM log
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: integration-vllm-log
          path: /tmp/vllm.log

  conformance-tests:
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    needs: build-and-test
    continue-on-error: true
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Launch vLLM container
        run: |
          docker run -d \
            --name vllm \
            --privileged=true \
            --net=host \
            quay.io/higginsd/vllm-cpu:65393ee064-qwen3 \
            --host 0.0.0.0 \
            --port 8000 \
            --enable-auto-tool-choice \
            --tool-call-parser hermes \
            --model /root/.cache/Qwen3-0.6B \
            --served-model-name Qwen/Qwen3-0.6B \
            --max-model-len 8192

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.24"
          cache-dependency-path: go.sum

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Build gateway
        run: make build

      - name: Wait for vLLM
        run: |
          echo "Waiting for vLLM to be ready..."
          timeout 900 bash -c 'until curl -fsS http://localhost:8000/health >/dev/null; do
            echo "Waiting for vLLM..."
            sleep 5
          done'
          echo "vLLM is ready"

      - name: Start server
        env:
          OPENAI_API_ENDPOINT: http://localhost:8000/v1
          OPENAI_API_KEY: unused
        run: |
          ./bin/openresponses-gw > /tmp/server.log 2>&1 &
          echo $! > /tmp/server.pid

      - name: Wait for server
        run: |
          for i in $(seq 1 30); do
            if curl -sf http://localhost:8080/health > /dev/null 2>&1; then
              echo "Server is ready"
              exit 0
            fi
            echo "Waiting for server... ($i/30)"
            sleep 2
          done
          echo "Server failed to start"
          cat /tmp/server.log
          exit 1

      - name: Run conformance tests
        run: ./tests/scripts/test-conformance.sh Qwen/Qwen3-0.6B

      - name: Upload server log
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: conformance-server-log
          path: /tmp/server.log

      - name: Upload vLLM log
        if: failure()
        run: docker logs vllm > /tmp/vllm.log 2>&1 || true

      - name: Upload vLLM log artifact
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: conformance-vllm-log
          path: /tmp/vllm.log
